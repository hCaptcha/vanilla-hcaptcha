<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo hCaptcha Web Component - Vanilla</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
</head>
<body class="bg-gray-50 p-8 font-sans">

<!--    <script src="https://cdn.jsdelivr.net/npm/@hcaptcha/vanilla-hcaptcha" async defer></script>-->
<script src="/node_modules/@hcaptcha/vanilla-hcaptcha/dist/index.min.js"></script>

<!-- Page Header -->
<div class="max-w-6xl mx-auto text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">hCaptcha Integration Demo</h1>
    <p class="text-gray-600 text-sm">Test different hCaptcha configurations and form submission</p>
</div>

<!-- Main Content Grid -->
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Left Column: Configuration & Status -->
    <div class="space-y-6">

        <!-- hCaptcha Configuration Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">hCaptcha Configuration</h2>
            <div class="bg-gray-50 p-4 rounded-lg">
            <div class="space-y-2">
                <label class="text-sm font-medium text-gray-600">Size:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="captchaSize" value="normal" class="mr-2" />
                        <span class="text-sm">Normal</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="captchaSize" value="compact" class="mr-2" />
                        <span class="text-sm">Compact</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="captchaSize" value="invisible" class="mr-2" checked />
                        <span class="text-sm">Invisible</span>
                    </label>
                </div>
            </div>

            <!-- Manual Testing Buttons -->
            <div class="mt-4 pt-3 border-t border-gray-200">
                <label class="text-sm font-medium text-gray-600 mb-2 block">Manual Testing:</label>
                <div class="flex gap-2">
                    <button onclick="executeHCaptcha()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium py-2 px-3 rounded-md transition duration-200">
                        EXECUTE
                    </button>
                    <button onclick="resetHCaptcha()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium py-2 px-3 rounded-md transition duration-200">
                        RESET
                    </button>
                </div>
            </div>
        </div>
        </div>

        <!-- Status History Section -->
        <div id="formStatus" class="bg-white rounded-lg shadow-md p-6 space-y-2 hidden relative">
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-semibold text-gray-800">Status History</h4>
                <button onclick="clearStatus()"
                        class="text-gray-400 hover:text-gray-600 transition-colors duration-200 p-1 rounded"
                        title="Clear status history">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
            <div id="statusMessages" class="space-y-1 max-h-48 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Right Column: Contact Form -->
    <div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Contact Form</h3>

            <form id="testForm" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name:</label>
                    <input type="text" id="name" name="name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Message:</label>
                    <textarea id="message" name="message" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"></textarea>
                </div>

                <div class="pt-2 border-t border-gray-200">
                    <div class="mb-3">
                        <h-captcha id="signupCaptcha"
                                   site-key="781559eb-513a-4bae-8d29-d4af340e3624"
                                   host="example.com"
                                   size="normal"
                                   theme="dark"
                                   recaptchacompat="false"
                                   tabindex="0"></h-captcha>
                    </div>

                    <button onclick="executeHCaptcha()"
                            class="h-captcha w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Submit Form
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>


<script>
    let signupCaptcha = document.getElementById('signupCaptcha');
    const testForm = document.getElementById('testForm');
    const formStatus = document.getElementById('formStatus');
    const sizeRadios = document.querySelectorAll('input[name="captchaSize"]');

    signupCaptcha.setAttribute("jsapi", "https://js.hcaptcha.com/1/api.js");

    sizeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                updateCaptchaSize(this.value);
            }
        });
    });

    function attachHCaptchaEventListeners(captchaElement) {
        captchaElement.addEventListener('loaded', () => {
            showStatus('hCaptcha Component Loaded', 'info');
            showStatus('Ready for auto-triggering on form submit', 'info');
        });

        captchaElement.addEventListener('verified', (e) => {
            showStatus('Auto-submitting form after hCaptcha verification...', 'info');

            // Following is simulation of form submission.
            // You would usually call "formElement.submit()";

            simulateFormSubmission(e.token);
        });

        captchaElement.addEventListener('expired', () => {
            showStatus('hCaptcha expired', 'warning');
            showStatus('Please try submitting again.', 'warning');
        });

        captchaElement.addEventListener('error', (e) => {
            showStatus(`hCaptcha error: ${e.error}`, 'error');
            showStatus('Please try again.', 'error');
        });
    }

    function updateCaptchaSize(newSize) {
        // Store current attributes
        const currentAttributes = {};
        for (let i = 0; i < signupCaptcha.attributes.length; i++) {
            const attr = signupCaptcha.attributes[i];
            currentAttributes[attr.name] = attr.value;
        }

        // Update size attribute
        currentAttributes.size = newSize;

        // Get parent container
        const parentContainer = signupCaptcha.parentElement;

        // Remove current element (triggers disconnectedCallback)
        signupCaptcha.remove();

        // Create new h-captcha element
        const newCaptcha = document.createElement('h-captcha');

        // Apply all attributes to new element
        Object.keys(currentAttributes).forEach(attrName => {
            newCaptcha.setAttribute(attrName, currentAttributes[attrName]);
        });

        // Add new element to DOM (triggers connectedCallback and auto-render)
        parentContainer.appendChild(newCaptcha);

        // Update global reference
        signupCaptcha = newCaptcha;

        // Re-attach event listeners
        attachHCaptchaEventListeners(signupCaptcha);

        showStatus(`hCaptcha re-rendered with size: ${newSize}`, 'success');
    }

    const currentSize = signupCaptcha.getAttribute('size') || 'normal';
    document.querySelector(`input[value="${currentSize}"]`).checked = true;

    // Attach initial event listeners
    attachHCaptchaEventListeners(signupCaptcha);

    // Form submission triggers hCaptcha.
    testForm.addEventListener('submit', (e) => {
        // Prevent default to handle via hCaptcha flow.
        e.preventDefault();
        showStatus(`Form submission initiated...`, 'info');
    });

    // Simulate actual form submission after hCaptcha success.
    function simulateFormSubmission(token) {
        const formData = new FormData(testForm);
        const formDataObj = Object.fromEntries(formData);
        const formDataStr = Object.keys(formDataObj).length > 0 ?
            Object.entries(formDataObj).map(([key, value]) => `${key}: "${value}"`).join(', ') :
            'No form data entered';
        showStatus('Form Data: ' + formDataStr, 'info');
        showStatus('hCaptcha Token: ' + token.substring(0, 20) + '...', 'info');
        showStatus('Form submitted successfully to server!', 'success');
    }

    function executeHCaptcha() {
        showStatus('Executing hCaptcha...', 'info');
        signupCaptcha.execute();
    }

    function resetHCaptcha() {
        showStatus('Resetting hCaptcha...', 'info');
        signupCaptcha.reset();
        showStatus('hCaptcha reset complete', 'info');
    }

    function showStatus(message, type = 'info') {
        const statusMessages = document.getElementById('statusMessages');
        formStatus.classList.remove('hidden');
        const timestamp = new Date().toLocaleTimeString();
        const messageElement = document.createElement('div');
        messageElement.className = 'text-xs p-2 rounded border-l-4 block w-full';
        let icon = '';
        switch(type) {
            case 'success':
                messageElement.classList.add('bg-green-50', 'text-green-800', 'border-l-green-400');
                icon = '✅';
                break;
            case 'error':
                messageElement.classList.add('bg-red-50', 'text-red-800', 'border-l-red-400');
                icon = '❌';
                break;
            case 'warning':
                messageElement.classList.add('bg-yellow-50', 'text-yellow-800', 'border-l-yellow-400');
                icon = '⚠️';
                break;
            default: // info
                messageElement.classList.add('bg-blue-50', 'text-blue-800', 'border-l-blue-400');
                icon = 'ℹ️';
        }

        messageElement.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${icon} ${message}`;
        statusMessages.insertBefore(messageElement, statusMessages.firstChild);
        statusMessages.scrollTop = 0;

        while (statusMessages.children.length > 15) {
            statusMessages.removeChild(statusMessages.lastChild);
        }
    }

    function clearStatus() {
        const statusMessages = document.getElementById('statusMessages');
        statusMessages.innerHTML = '';
        formStatus.classList.add('hidden');
        showStatus('Status history cleared', 'info');
    }
</script>
</body>
</html>
